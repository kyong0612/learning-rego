# OPA/Regoとはなんなのか

- OPAはサービスやソフトウェアの意思決定機能を本体と分離するために作られたエンジン
  - 意思決定とは
    - IaCに記述された設定に危険な構成(例えばアクセス制御が適切でない)のチェック
    - デプロイされたリソースがポリシーに準拠した設定・構成になっているかのチェック
- OPAを使う方法はいくつか用意されており、大きく以下の3つに分類できる。
  1. opaコマンドによってクエリを指定して評価し、クエリをHTTPで送信・判定結果を受信する
  2. opaコマンドによってHTTPサーバを起動し、クエリをHTTPで送信・判定結果を受信する
  3. github.com/open-policy-agent/opa/rego パッケージを使った自作のGoプログラムを使う

## example

- ポリシー

```rego
default allow = false

allow {
    input.roles[_] == "admin"
}
```

- クエリ

```json
{
    "user": "kyong0612",
    "roles": ["admin", "developer"]
}
```

- 判定結果

```json
{
    "allow": true
}
```

## OPA・Regoを使うメリット・デメリット

- メリット
  - ポリシーと実装を分離できる
  - 意思決定に必要な機能だけが提供されている
  - 自分でポリシーエンジンを実装しなくて良い

- デメリット
  - Regoの学習コストが高め
    - Regoはprologの系譜を持つ宣言的プログラミング言語になる。
      - 今日、広く使われているプログラミング言語は大部分が手続き型プログラミング言語であるため、宣言的プログラミング言語に慣れていない人にとっては学習コストが高い
  - ポリシーと実装が疎結合ゆえにミスが起こりうる
    - ポリシーと実装が疎結合であるため、ポリシーの変更に伴う実装の変更漏れが起こりうる
